
# In Bound Flow

## Flow 1

```
Zoom
  |
  v
+14125019986  [Twilio Number]
  |
  v
Twilio
  |
  v
Asterisk (34.46.135.148)
  |
  v
Sound(Play Voice)
```

#### Flow 1: `pjsip.conf`

```conf
[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060
external_media_address=34.46.135.148
external_signaling_address=34.46.135.148
; If your server is behind NAT, uncomment the lines below:
; external_media_address=34.46.135.148
; external_signaling_address=34.46.135.148

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; OUTBOUND TO TWILIO
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

[twilio-trunk]
transport=transport-udp

[twilio-trunk]
type=identify
endpoint=twilio-trunk
match=54.172.60.0/30  ; Twilio North America East IP range
match=54.244.51.0/30  ; Twilio North America West IP range
; Note: Add other Twilio regions if you aren't using localized URIs

[twilio-trunk]
type=endpoint
transport=transport-udp
context=from-twilio
disallow=all
allow=ulaw
direct_media=no
rtp_symmetric=yes
force_rport=yes
rewrite_contact=yes
dtmf_mode=rfc4733
trust_id_inbound=yes

[twilio-trunk]
type=aor
max_contacts=0
```

#### Flow 1: `extension.conf`

```conf
[general]
static=yes
writeprotect=no

[from-twilio]
; Handling INBOUND calls from Twilio
exten => +14125019986,1,NoOp(Inbound call from Twilio)
 same => n,Answer()
 same => n,Playback(demo-congrats) ; Play a test sound
 same => n,Hangup()

[default]
; Handling OUTBOUND calls (example: dial 9 followed by number)
exten => _9X.,1,NoOp(Outbound call to Twilio)
 same => n,Set(CALLERID(num)=+14125019986)
 same => n,Dial(PJSIP/${EXTEN:1}@twilio-trunk)
 same => n,Hangup()
```

#### Flow 1: `rtf.conf`

```conf
[general]
;
; RTP start and RTP end configure start and end addresses
;
; Defaults are rtpstart=5000 and rtpend=31000
;
rtpstart=10000
rtpend=20000
```

## Flow 2

```
PSTN Call
↓
Twilio Number
↓  (Webhook)
FastAPI /incoming_call  ← THIS
↓  (TwiML <Connect><Stream>)
Twilio Media Stream (WebSocket)
↓
Your Bot (Deepgram + OpenAI + ElevenLabs)
```

#### Flow 2: `pjsip.conf`

```conf
[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060
external_media_address=34.46.135.148
external_signaling_address=34.46.135.148

[twilio-trunk]
type=endpoint
transport=transport-udp
context=from-twilio
disallow=all
allow=ulaw
direct_media=no
rtp_symmetric=yes
force_rport=yes
rewrite_contact=yes
dtmf_mode=rfc4733
trust_id_inbound=yes
aors=twilio-trunk

[twilio-trunk]
type=aor
contact=sip:voicing-asterisk.pstn.twilio.com:5060

[twilio-trunk]
type=identify
endpoint=twilio-trunk
match=54.172.60.0/30
match=54.244.51.0/30
```
#### Flow 2: `extension.conf`

```conf
[general]
static=yes
writeprotect=no

[from-twilio]
exten => +14125019986,1,NoOp(Inbound call from Twilio Number)
 ; Use the format: PJSIP/ENDPOINT_NAME/sip:USER@DOMAIN
 same => n,Dial(PJSIP/twilio-trunk/sip:bot@voicing-asterisk.sip.twilio.com,60)
 same => n,Hangup()


[default]
; Handling OUTBOUND calls (example: dial 9 followed by number)
exten => _9X.,1,NoOp(Outbound call to Twilio)
 same => n,Set(CALLERID(num)=+14125019986)
 same => n,Dial(PJSIP/${EXTEN:1}@twilio-trunk)
 same => n,Hangup()

[from-asterisk]
exten => bot,1,NoOp(Call to Twilio Bot)
 same => n,Dial(PJSIP/bot@voicing-asterisk.sip.twilio.com@twilio-trunk,30)
 same => n,Hangup()
```

#### Flow 2: `rtf.conf`

```conf
;
; RTP Configuration
;
[general]
;
; RTP start and RTP end configure start and end addresses
;
; Defaults are rtpstart=5000 and rtpend=31000
;
rtpstart=10000
rtpend=20000
```



### Components Roles and Responsibility

| Component           | Role                             |
| ------------------- | -------------------------------- |
| Zoom                | Calls a PSTN number              |
| Twilio Phone Number | Receives PSTN call               |
| Twilio SIP Domain   | Converts PSTN → SIP              |
| Asterisk            | Handles SIP + RTP                |
| Bot                 | Business logic (audio + control) |
